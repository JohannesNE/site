---
title: "2020-01-19-intermediate-dplyr"
author: 
- "Sara Tomiolo"
- "Luke Johnston"

date: "1/17/2020"
description: >
  Learn to reshape data in long or wide form, manage factors and dates using the packages dplyr, tidyr, lubridate, forcats and stringr.
categories:
  - Intermediate
  - R
  - Code-along
tags:
  - tidyr
  - dplyr
  - forcats
  - stringr
  - lubridate
  - data manipulation
  - factors
  - dates
---


```{r setup, echo=FALSE}
source(here::here("R/utils-for-content.R"))
```

## Preparation

Please install the tidyverse package:

```{r, eval=FALSE}
install.packages("tidyverse")
library(lubridate)
```

### Prerequisites

In this lesson we assume you are familiar with the basic functions of dplyr (especially group-by() and summarize()), if not we recommend you to take a look at the [intro_dplyr lesson](https://au-cru.github.io/site/material/2019-11-15-intro-dplyr/) 


### Objectives

I know the cognitive load is insane, I am just jotting down ideas and the how can I make them work together, then I will select 3 objectives out of all this and cut the rest. 
1. To learn to restructure your data between long and wide format with pivot_longer() and pivot_wider() functions from tidyr package.
2. Learn to combine group_by() and summarize() function with pivot_longer() and pivot_wider() functions.
3. Handle factor variables using functions.... from the forcacts package.
4. Manage dates with lubridate functions.
5. Create new variables by joining or separating previously existing variables using the functions of the package stringr.
    
**At the end of this session you will be able:**

1. To restructure your data in long or wide format.
2. To reshape data by using grouping, summarizing and reshaping dataframes.
2. To manage and reorder the level of factorial variables.
3. Reformat dates with lubridate

### Why learning to reformat and reshape data?

Often we receive databases that have been created by others, and in  whcih information is organized in a "messy" way. Some other time, we simply need to reorder the structure of the data to be able to carry out certain data analysis or data visualization. Tidyverse, provide some very powerful packages that can allow for complete reorganization of our data in a few lines of codes. Using these packages and their functions has several advantages:

- It makes our lives easier and our work faster, because we  can jump between different formats of our data in an agile and easy to track way;

- It makes our work enterely reproducible.

### Wide and long formats

One of the most common operation that we may need to do is to change the way our data is organized, from a long (few columns, many rows) to a wide (few rows, many columns) format.

The functions we want to use for these operations are respectively `pivot_longer()` and `pivot_wider()` from the tidyr package (Those of you already familiar with this package may know these functions as spread() and gather(). Although these formats still work, they are being slowly replaced by the pivot_ functions).

To show how these functions work, we are going to use the built-in dataframe `population`.

#### Familiarize with the dataframe

Using the function View() inspect the dataframe population, which shows the populations census in different countries across multiple years.

```{r}
View(population)
```

Say that we want to explore how the population varies across years in each country. To do this we may want to show each single country as a separate variable (i.e. column). 

To do this we will need to reshape your data, so that the single countries now listed under the variable `country` become each a different variable, under which the population number, now listed under the variable `population`, are listed.

To do so, we will use the function `pivot_wider()` because we want to create a wider dataframe with more columns (the single countries), and less rows.

We will call this new dataframe population_wide.
In the function pivot_wider() we want to specify three arguments: 

- the dataframe to work on,
- the name of the "long" variable that we will use to create the new "wide" variables
- the values that we will use to fill the rows of the new variable we created

```{r}
population_wide <- population %>% 
  pivot_wider(names_from = country, values_from = population) 
```

we can also do  the opposite, shift from a wide format to a long one. 
Let's consider our `population_wide` dataframe as the starting point, and say we want to reshape to data to a format in which all countries are listed under a single variable, e.g. "country_name", and the population data are listed under a variable called "population_data". For this operation we need to use the function `pivot_longer()`

In this case we want to specify:
- the name of the new variable under which we want to group our columns, 
- the name of new variable under which we want to group the values of our variables.

We run our function...

```{r}
population_wide %>%
  pivot_longer(names_to = "Country", values_to = "Population")
```

... but we get an error message!

There is one variable in the dataframe population_wide that we have not dealt with: "year". We do not want to change the arrangement of this variable, and R detects that this is a different variable from the other columns that we want to reshape but not knowing what to do with it, it throws an error. 

We need to specify that the variable "year", because there is a variable "year", that we do not want to involve in the reshaping.

```{r}
population_wide %>%
  pivot_longer(-year, names_to = "Country", values_to = "Population")
```
